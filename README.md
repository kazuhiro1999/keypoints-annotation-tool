# keypoints-annotation-tool-for-dance-video

## 概要
  このブランチはダンス動画用のキーポイントアノテーションツールです。  
  使い方は以下の動画で詳しく紹介しています。   
  - 作業編：https://youtu.be/SwvJ9fjki6U  

## 事前準備
- **プログラムのダウンロード**  
  このリポジトリをクローンするか、Zipファイルをダウンロードして解凍してください。
  
- **データのダウロード**  
  指定の方法でデータを入手してください。  
  プログラムと同じ場所にデータフォルダを作成することをおすすめします。  

  
## キーポイントの説明
以下の説明を参考に、キーポイントのアノテーションを行ってください。  
  ![画像の説明](Pictures/keypoints_explanation.png)
- Hips ... 尻（尾てい骨辺り）
- Spine ... 腰（おへその辺り）
- Chest ... 腹部
- UpperChest ... 胸部
- Neck ... 首の付け根
- HeadTop ... 頭頂
- Nose ... 鼻
- Eye ... 目
- Ear ... 耳
- Jaw ... あご先
- Shoulder ... 肩甲骨の内側
- UpperArm ... 肩（上腕の付け根）
- LowerArm ... 肘
- Hand ... 手首
- Palm ... 手のひらの中心部　※見えている場合のみマーク
- Thumb ... 親指の先端
- FingerTip ... 指全体の先端
- Little ... 小指の先端
- UpperLeg ... 太ももの付け根
- LowerLeg ... 膝
- Heel ... かかと（靴の後ろ側）
- Toe ... つま先（親指側）

## アノテーションツールの使い方
- **ツールの起動**  
  main.exeを起動（Windowsから警告が出るが、詳細情報→実行を押す）  
  動画が入っているフォルダを選択してOK（このフォルダはどこに置いても良い）  
  ※初回セットアップ時にcannot setup files のエラーが出る場合はファイル構成をもう一度確認してください  
  
- **キーポイントのアノテーション**  
  1. 右側のリストからキーを選択  
  2. 画像上の対応する位置にカーソルを合わせ、右クリックで作成  
  3. 左クリックで選択、ドラッグで動かして位置を調整（右側のボタンでも調整可）  
  （選択しながらDeleteキーを押すことでキーポイントを削除できます）  
  
  <ins>赤色で表示されているキーポイントを適切な位置へ移動させて修正してください。</ins>  
  <ins>すべてのキーポイントが緑色になれば終了です。</ins>  
  
- **キーポイントの色について**   
  緑色：アノテーション済のキーポイント  
  赤色：まだアノテーションしていないキーポイント  
  
- **スケルトンの表示**  
  View→Show Skeleton でスケルトン表示が可能（Sキーでも表示・非表示の切り替えが可能）   

- **カメラの切り替え**  
  上部の小さい画像をクリックでカメラの切り替え  

- **フレームの移動**  
  下部のボタンでフレームの移動  
  上下キー：フレームの間隔設定  
  左右キー（Prev, Next）：フレームの移動  
  ※フレームを移動すると、前フレームのアノテーション情報を用いてキーポイントが自動でアノテーションされます。

- **Triangulation**  
  2つ以上のカメラでアノテーションされたキーポイントを、cv2のtriangulate機能を使って3次元座標に変換します。  
  アノテーションがまだ終わっていないカメラに、位置を反映させます。  
  ※2つのカメラ同士の角度が90°のカメラで行うと正確に反映されます。またアノテーション済みのカメラが多いほど正確になります。  

- **Interpolation**  
  前後のフレーム（10フレームまで）を使って、キーポイントの位置を線形補間します。  
  間隔が狭いほど正確に補間できます。  （AISTの場合、間隔が5フレームで誤差が1cm程度）  

- **進捗確認**  
  Tools→Check Progress で進捗が確認できます。  
  右側のリストでキーの絞り込み、グラフは縦軸がアノテーションの達成率（％）で横軸がフレーム番号です。  

- **アノテーションデータの保存**  
  File→Saveでアノテーションデータが保存されます。  
  作業中はこまめに保存してください。  
  
- **ショートカットキー**  
  - カーソルキー左右：フレームの移動
  - カーソルキー上下：フレーム間隔の設定
  - Shiftキー：選択中のキーの切り替え
  - Ctrl+Z：一つ前に戻る
  - S：スケルトンの表示・非表示
  - T：Triangulate
  - I：Interpolate

## アノテーションデータの共有  
  データフォルダ内の.pklファイルをお送りください。  
  複数ある場合はoutput.exeで同ディレクトリ内の全てのフォルダのアノテーションデータを集約してzip化することができます。  
